stages:
    - deploy

.deploy_template: &deploy_template
    stage: deploy
    script:
    - whoami
    - kill -SIGKILL $(pidof git) || true
    - >
        srv=0;
        vol=0;
        echo "set variables to 0";
        cd "/srv/daemon-data" && srv=1 || srv=0;
        cd "/var/lib/pterodactyl/volumes" && vol=1 || vol=0;
        echo "srv = $srv, vol = $vol";
        if (( srv == 1 && vol == 1 )); then
            srvsize=$(du /srv/daemon-data/ -Hs | cut -f 1);
            volsize=$(du /var/lib/pterodactyl/volumes -Hs | cut -f 1);
            if ((srvsize > volsize)); then
                vol=0;
                echo "srv is bigger than vol, using that!";
            elif ((volsize > srvsize)); then
                srv=0;
                echo "vol is bigger than srv, using that!";
            fi;
        fi;

        if ((srv == 1)); then
            cd /srv/daemon-data || exit;
        elif ((vol == 1)); then
            cd /var/lib/pterodactyl/volumes || exit;
        else
            exit;
        fi;
    - >
        for d in ./*/ ; do
            cd "$d";
            echo "Checking: $d"
            if [ -d ".git" ]; then

                CI_LOCAL_REMOTE=`git remote get-url origin`;
                CI_LOCAL_REMOTE="${CI_LOCAL_REMOTE##*@}";
                CI_LOCAL_REMOTE=`echo $CI_LOCAL_REMOTE | tr : /`
                CI_LOCAL_REMOTE=${CI_LOCAL_REMOTE%.git}

                CI_REMOTE_REMOTE="$CI_SERVER_HOST/$CI_PROJECT_PATH.git"
                CI_REMOTE_REMOTE=`echo $CI_REMOTE_REMOTE | tr : /`
                CI_REMOTE_REMOTE=${CI_REMOTE_REMOTE%.git}

                echo "Comparing remotes $CI_LOCAL_REMOTE and $CI_REMOTE_REMOTE."
                if [ $CI_LOCAL_REMOTE == $CI_REMOTE_REMOTE ]; then

                    echo "Comparing branches `git rev-parse --abbrev-ref HEAD` and $CI_COMMIT_REF_NAME."
                    if [ `git rev-parse --abbrev-ref HEAD` == $CI_COMMIT_REF_NAME ]; then

                        echo "cleaning any old git locks..."
                        rm .git/index.lock -v || true
                        echo "setting git config"

                        git config --global user.email "support@creators.tf"
                        git config --global user.name "Creators.TF Production"

                        COMMIT_OLD=$(git rev-parse HEAD);

                        echo "clearing stash"
                        git stash clear;

                        echo "fetching"
                        git fetch origin $CI_COMMIT_REF_NAME;

                        echo "resetting"
                        git reset --hard origin/$CI_COMMIT_REF_NAME;

                        echo "cleaning cfg folder" 
                        git clean -d -f -x tf/cfg/

                        echo "cleaning maps folder"
                        git clean -d -f tf/maps

                        # UNCOMMENT THESE LINES TO FORCE CLEANUP OF EXTRA BULLSHIT THAT MIGHT BE ON SERVERS
                        # echo "git clean"
                        # git clean -d -f -x tf/addons/sourcemod/plugins/
                        # git clean -d -f -x tf/addons/sourcemod/plugins/external
                        # git clean -d -f -x tf/addons/sourcemod/data/
                        # git clean -d -f -x tf/addons/sourcemod/gamedata/
                        # THIS WILL DELETE ALL SOURCEMOD LOGS, INCLUDING STAC AND CHAT LOGS
                        # git clean -d -f -x tf/addons/sourcemod/logs/

                        echo "chmodding"
                        chmod 744 build.sh;
                        chmod 744 start.sh;
                        chmod 744 str0.py;
                        chmod 744 str0.ini;

                        echo "running str0 to scrub steamclient spam"
                        python3 ./str0.py ./bin/steamclient.so -c ./str0.ini

                        # don't run this often
                        echo "garbage collecting"
                        git gc --auto ;


                        echo "building"
                        ./build.sh $COMMIT_OLD;
                    fi;
                fi;
            fi;
            cd ../;
        done


deploy-europe:
    tags:
    - eupub
    <<: *deploy_template

deploy-europe2:
    tags:
    - eu2pub
    <<: *deploy_template

deploy-virginia:
    tags:
    - virginiapub
    <<: *deploy_template

deploy-singapore:
    tags:
    - sgppub
    <<: *deploy_template

deploy-australia:
    tags:
    - auspub
    <<: *deploy_template

deploy-la:
    tags:
    - lapub
    <<: *deploy_template

deploy-chicago3:
    tags:
    - chicago3
    <<: *deploy_template

#deploy-uspotato1:
#    tags:
#    - uspotato1
#    <<: *deploy_template

deploy-eupotato1:
    tags:
    - eupotato1
    <<: *deploy_template

#deploy-eupotato2:
#    tags:
#    - eupotato2
#    <<: *deploy_template

# TODO: why is this here? doesn't this run on the backend server? dafaq?
deploy-fastdl:
    stage: deploy
    script:
    - whoami
    - shopt -s globstar

    - SHA_BEFORE="$CI_COMMIT_BEFORE_SHA"
    - SHA_AFTER="$CI_COMMIT_SHA"

    - echo "Comparing $SHA_BEFORE // $SHA_AFTER"
    - GIT_DIFF=`git diff --name-only $SHA_AFTER $SHA_BEFORE`

    - cd $CI_PROJECT_DIR
    - git checkout $CI_COMMIT_REF_NAME
    - git reset --hard origin/$CI_COMMIT_REF_NAME

    - echo "[INFO] Repository path = $CI_PROJECT_DIR"

    - FASTDL_PATH="/var/www/fastdl/content/branches/$CI_COMMIT_REF_NAME";
    - cd tf;

    - >
        while read pattern; do

            echo "Pattern: $pattern"

            # We go through all the files of this pattern and see if bz2 version is valid.
            for i in ./$pattern; do

                # Skip missing files.
                [[ ! -f $i ]] && continue;

                ASSET_SRC_PATH=`realpath $i`;
                ASSET_FASTDL_PATH=$FASTDL_PATH/$i;
                ASSET_BZ2_PATH=$ASSET_FASTDL_PATH.bz2;

                RECOMPRESS=0;

                # Recompress if bz2 file does not exist.
                [[ ! -f $ASSET_BZ2_PATH ]] && RECOMPRESS=1;

                # Recomress if checksums do not match.
                if [[ $RECOMPRESS = 0 ]]; then

                    GIT_DIFF_ELEMENT=`realpath --relative-to ./ $i`;

                    # If it exist, let's first check if it changed.
                    if [[ `echo $GIT_DIFF | grep $GIT_DIFF_ELEMENT` ]]; then
                        RECOMPRESS=1;
                    fi
                fi

                if [[ $RECOMPRESS = 1 ]]; then

                    # Remove old bz2 if exists.
                    [[ -f $ASSET_BZ2_PATH ]] && rm $ASSET_BZ2_PATH;

                    # Validate directories
                    mkdir -p ${ASSET_FASTDL_PATH%/*}

                    # Copying the src file.
                    cp $ASSET_SRC_PATH $ASSET_FASTDL_PATH;

                    echo "[INFO] Archiving $ASSET_FASTDL_PATH";
                    bzip2 $ASSET_FASTDL_PATH;
                fi

            done
        done < ../.ci-fastdl
    - exit

    tags:
    - fastdl
    only:
    - master
    - staging
    - mvm
    
